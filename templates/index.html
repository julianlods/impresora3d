{% extends "base.html" %}
{% block title %}Inicio — El Sultán del Plástico{% endblock %}

{% block content %}
<div class="text-center my-2">
	<h1 class="text-3xl md:text-4xl font-bold text-amber-700 mb-2">
		Catálogo de Productos
	</h1>
</div>

<div class="text-center mt-4">
	<div class="relative px-2 sm:px-8 overflow-x-hidden">
		<!-- Flecha izquierda -->
		<button id="prev" type="button"
			class="hidden sm:flex absolute left-1 sm:left-0 top-1/2 -translate-y-1/2 z-50
			       bg-white text-gray-900 shadow rounded-full p-2">
			&#10094;
		</button>

		<!-- Carrusel horizontal -->
		<div id="carousel"
			class="flex overflow-x-auto gap-4 scroll-smooth pb-4 scrollbar-hide snap-x snap-mandatory">
			{% for p in productos %}
				<div data-card class="min-w-[260px] max-w-[260px] snap-start flex-shrink-0
									bg-white text-gray-900 rounded-xl border border-gray-200
									shadow hover:shadow-lg transition p-4">
				{% set src = p.image_url %}
				<div class="w-full rounded-lg bg-gray-50 border border-gray-100 overflow-hidden" style="aspect-ratio: 4 / 3;">
					<img
					src="{{ src if src and src.startswith('http') else url_for('static', filename=(src or 'images/placeholder.png')) }}"
					alt="{{ p.name }}"
					class="w-full h-full object-contain"
					>
				</div>

				<h3 class="text-base font-semibold mt-3 line-clamp-2">{{ p.name }}</h3>

				{% if p.description %}
					<p class="text-sm text-gray-600 mt-1 line-clamp-3">{{ p.description }}</p>
				{% endif %}

				<div class="mt-2 flex items-center justify-between">
					{% if p.category %}
					<span class="text-xs text-gray-500">{{ p.category.name }}</span>
					{% else %}
					<span></span>
					{% endif %}
					{% if p.price %}
					<span class="text-sm font-bold text-gray-900">${{ p.price }}</span>
					{% endif %}
				</div>

				<a href="{{ url_for('producto', slug=p.slug) }}"
					class="mt-3 inline-block bg-gray-900 text-white hover:bg-black
							px-3 py-1.5 rounded-full text-sm font-medium">
					VER PRODUCTO
				</a>
				</div>
			{% else %}
				<p class="text-gray-300">No hay productos cargados.</p>
			{% endfor %}
		</div>

		<!-- Flecha derecha -->
		<button id="next" type="button"
			class="hidden sm:flex absolute right-1 sm:right-0 top-1/2 -translate-y-1/2 z-50
			       bg-white text-gray-900 shadow rounded-full p-2">
			&#10095;
		</button>
	</div>
</div>

<style>
	/* ocultar scrollbar del carrusel */
	.scrollbar-hide::-webkit-scrollbar { display: none; }
	.scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
	const carousel = document.getElementById('carousel');
	const prev = document.getElementById('prev');
	const next = document.getElementById('next');
	if (!carousel || !prev || !next) return;

	// calcular el paso: ancho de una card + gap horizontal
	const firstCard = carousel.querySelector('[data-card]');
	const styles = getComputedStyle(carousel);
	const gap = parseInt(styles.columnGap || styles.gap || '16', 10);
	const fallback = Math.max(280, Math.floor(carousel.clientWidth * 0.9));
	const step = firstCard ? firstCard.getBoundingClientRect().width + gap : fallback;

	const scrollByX = (dx) => {
		if (typeof carousel.scrollBy === 'function') {
			carousel.scrollBy({ left: dx, behavior: 'smooth' });
		} else {
			carousel.scrollLeft += dx;
		}
	};

	prev.addEventListener('click', () => scrollByX(-step));
	next.addEventListener('click', () => scrollByX(step));

	// mostrar flechas solo en >= sm (igual que las clases)
	const updateArrows = () => {
		const show = window.matchMedia('(min-width: 640px)').matches;
		prev.style.display = next.style.display = show ? 'flex' : 'none';
	};
	updateArrows();
	window.addEventListener('resize', updateArrows);
});
</script>

<!-- Sección Solicitar artículo -->
<div class="mt-10 text-center">
  <h2 class="text-2xl font-bold text-amber-700 mb-3">
    ¿No encontrás lo que buscás?
  </h2>
  <p class="text-gray-700 mb-4">
    Contame qué artículo necesitás y el Sultán lo hará para vos.
  </p>

  {% with msgs = get_flashed_messages(with_categories=True) %}
    {% if msgs %}
      {% set cat, msg = msgs[-1] %}
      <div id="toast-overlay" class="fixed inset-0 z-[999] grid place-items-center bg-black/30">
        <div id="toast"
             class="w-[min(90vw,480px)] rounded-2xl shadow-xl border px-5 py-4 text-center
                    bg-white text-gray-900
                    {% if cat == 'success' %} border-green-200 {% else %} border-red-200 {% endif %}">
          <p class="text-base font-semibold mb-1
                    {% if cat == 'success' %} text-green-700 {% else %} text-red-700 {% endif %}">
            {% if cat == 'success' %}Listo{% else %}Atención{% endif %}
          </p>
          <p class="text-sm">{{ msg }}</p>
          <button id="toast-close"
                  class="mt-3 inline-flex items-center rounded-full border px-3 py-1 text-sm
                         hover:bg-gray-50">Cerrar</button>
        </div>
      </div>

      <script>
        document.addEventListener('DOMContentLoaded', function () {
          const overlay = document.getElementById('toast-overlay');
          const closeBtn = document.getElementById('toast-close');

          function hideToast() {
            if (!overlay) return;
            overlay.style.transition = 'opacity 300ms ease';
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 320);
          }

          setTimeout(hideToast, 5000);           // se oculta a los 5s
          closeBtn?.addEventListener('click', hideToast);
          overlay?.addEventListener('click', (e) => { if (e.target === overlay) hideToast(); });
        });
      </script>
    {% endif %}
  {% endwith %}

  <form action="{{ url_for('solicitar_articulo') }}" method="post" class="max-w-md mx-auto flex flex-col sm:flex-row gap-3">
    <input
      type="text"
      name="nombre_articulo"
      placeholder="Escribí el nombre del artículo"
      class="flex-grow px-4 py-2 rounded border border-gray-300 focus:outline-none focus:ring-2 focus:ring-amber-500"
      required
    >
    <button
      type="submit"
      class="bg-amber-700 hover:bg-amber-800 text-white px-6 py-2 rounded font-semibold">
      Solicitar
    </button>
  </form>
</div>

{% endblock %}